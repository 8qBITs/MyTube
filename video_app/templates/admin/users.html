{% extends "admin/base_admin.html" %}
{% block title %}Users - Admin - MyTube{% endblock %}

{% block admin_content %}
<div class="d-flex align-items-center mb-3">
  <h2 class="mb-0">Users</h2>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Existing Users</strong>

    <!-- Create user dropdown button (compact, like before) -->
    <div class="dropdown">
      <button class="btn btn-sm btn-primary dropdown-toggle" type="button"
              id="createUserDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        Create User
      </button>
      <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 280px;">
        <h6 class="dropdown-header px-0">New User</h6>
        <form method="post">
          <input type="hidden" name="action" value="create_user">
          <div class="mb-2">
            <label class="form-label form-label-sm mb-1">Email</label>
            <input class="form-control form-control-sm" type="email" name="new_email" required>
          </div>
          <div class="mb-2">
            <label class="form-label form-label-sm mb-1">Password</label>
            <input class="form-control form-control-sm" type="password" name="new_password" required>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="new_is_admin" name="new_is_admin">
            <label class="form-check-label small" for="new_is_admin">
              Make this user an admin
            </label>
          </div>
          <button type="submit" class="btn btn-sm btn-success w-100">
            Create
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Email</th>
            <th>Admin</th>
            <th>Banned</th>
            <th>Reg. IP</th>
            <th>Created</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.email }}</td>
            <td>
              {% if user.is_admin %}
                <span class="badge bg-primary">Admin</span>
              {% else %}
                <span class="badge bg-secondary">User</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_banned %}
                <span class="badge bg-danger">Banned</span>
              {% else %}
                <span class="badge bg-success">Active</span>
              {% endif %}
            </td>
            <td class="small">
              {{ user.registered_ip or "-" }}
            </td>
            <td class="small">
              {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '' }}
            </td>
            <td class="text-end">
              <!-- Admin / remove admin -->
              <form method="post" class="d-inline">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                {% if not user.is_admin %}
                  <button name="action" value="make_admin"
                          class="btn btn-sm btn-outline-primary mb-1">
                    Make Admin
                  </button>
                {% else %}
                  <button name="action" value="remove_admin"
                          class="btn btn-sm btn-outline-secondary mb-1">
                    Remove Admin
                  </button>
                {% endif %}
              </form>

              <!-- Ban / unban -->
              <form method="post" class="d-inline">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                {% if not user.is_banned %}
                  <button name="action" value="ban"
                          class="btn btn-sm btn-outline-warning mb-1">
                    Ban
                  </button>
                {% else %}
                  <button name="action" value="unban"
                          class="btn btn-sm btn-outline-success mb-1">
                    Unban
                  </button>
                {% endif %}
              </form>

              <!-- Delete (non-admin only) -->
              {% if not user.is_admin %}
              <form method="post" class="d-inline"
                    onsubmit="return confirm('Delete this user? This cannot be undone.');">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <button name="action" value="delete"
                        class="btn btn-sm btn-outline-danger mb-1">
                  Delete
                </button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-3">
              No users found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
